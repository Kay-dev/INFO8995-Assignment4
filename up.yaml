---
- hosts: localhost
  tasks:
  - name: "Install kubernetes python package"
    pip:
      name: kubernetes
      state: present

  - name: "Create a new k8s namespace"
    kubernetes.core.k8s:
      name: jenkins
      api_version: v1
      kind: Namespace
      state: present

  - name: "Deploy a new k8s persistent volume"
    kubernetes.core.k8s:
      state: present
      definition:
        apiVersion: v1
        kind: PersistentVolume
        metadata:
          name: jenkins-pv
          labels:
            type: local
        spec:
          storageClassName: manual
          capacity:
            storage: 10Gi
          accessModes:
            - ReadWriteOnce
          hostPath:
            path: "/data/jenkins-volume"

  - name: "Deploy Jenkins persistent volume claim"
    kubernetes.core.k8s:
      state: present
      definition:
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: jenkins-pvc
          namespace: jenkins
        spec:
          storageClassName: manual
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 10Gi

  - name: "Deploy jenkins service"
    kubernetes.core.k8s:
      state: present
      definition:
        apiVersion: v1
        kind: Service
        metadata:
          name: jenkins
          namespace: jenkins
        spec:
          type: NodePort
          ports:
            - port: 8080
              targetPort: 8080
              nodePort: 30000
          selector:
            app: jenkins

  - name: "Deploy jenkins-jnlp service"
    kubernetes.core.k8s:
      state: present
      definition:
        apiVersion: v1
        kind: Service
        metadata:
          name: jenkins-jnlp
          namespace: jenkins
        spec:
          type: ClusterIP
          ports:
            - port: 50000
              targetPort: 50000
          selector:
            app: jenkins

  - name: "Deploy Jenkins deployment"
    kubernetes.core.k8s:
      state: present
      definition:
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: jenkins
          namespace: jenkins
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: jenkins
          template:
            metadata:
              labels:
                app: jenkins
            spec:
              containers:
                - name: jenkins
                  image: jenkins/jenkins:lts
                  ports:
                    - name: http-port
                      containerPort: 8080
                    - name: jnlp-port
                      containerPort: 50000
                  volumeMounts:
                    - name: jenkins-vol
                      mountPath: /var/jenkins_vol
                  resources:
                    limits:
                      memory: "2Gi"
                      cpu: "1000m"
                    requests:
                      memory: "1Gi"
                      cpu: "500m"
              volumes:
                - name: jenkins-vol
                  persistentVolumeClaim:
                    claimName: jenkins-pvc
